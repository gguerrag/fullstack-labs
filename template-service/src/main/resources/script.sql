---- PRIMER MICRO SERVICIO LAB
---- CREACIÓN DE USUARIO Y PRIVILEGIOS
CREATE USER LAB_APP IDENTIFIED BY "P4rM3d-Labs#2025!"
  DEFAULT TABLESPACE DATA
  TEMPORARY TABLESPACE TEMP;
  
ALTER USER LAB_APP QUOTA 500M ON DATA;

GRANT CREATE SESSION TO LAB_APP;
GRANT CREATE TABLE, CREATE SEQUENCE, CREATE VIEW, CREATE TRIGGER, CREATE PROCEDURE TO LAB_APP;

---- SEGUNDO MICRO SERVICIO USER
---- CREACIÓN DE USUARIO Y PRIVILEGIOS
CREATE USER LAB_USERS IDENTIFIED BY "P4rM3d-Users#2025!"
  DEFAULT TABLESPACE USERS
  TEMPORARY TABLESPACE TEMP
  QUOTA UNLIMITED ON USERS;

GRANT CREATE SESSION TO LAB_USERS;
GRANT CREATE TABLE, CREATE SEQUENCE, CREATE VIEW, CREATE TRIGGER, CREATE PROCEDURE TO LAB_USERS;
GRANT UNLIMITED TABLESPACE TO LAB_USERS;

---- POBLAR TABLA DE MICRO SERVICIO LAB CON USUARIO  LAB_APP 
-- Tabla de usuarios
CREATE TABLE USERS (
  ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EMAIL         VARCHAR2(255) NOT NULL UNIQUE,
  DISPLAY_NAME  VARCHAR2(255) NOT NULL,
  PASSWORD_HASH VARCHAR2(255) NOT NULL,
  ENABLED       CHAR(1) DEFAULT 'Y' CHECK (ENABLED IN ('Y','N')),
  CREATED_AT    TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- Tabla de roles
CREATE TABLE ROLES (
  ID   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NAME VARCHAR2(50) NOT NULL UNIQUE
);

-- Relación usuarios - roles
CREATE TABLE USER_ROLES (
  USER_ID NUMBER NOT NULL,
  ROLE_ID NUMBER NOT NULL,
  CONSTRAINT PK_USER_ROLES PRIMARY KEY (USER_ID, ROLE_ID),
  CONSTRAINT FK_UR_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE,
  CONSTRAINT FK_UR_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ID) ON DELETE CASCADE
);

-- Índices recomendados
CREATE INDEX IDX_USERS_EMAIL ON USERS(EMAIL);
CREATE INDEX IDX_USER_ROLES_USER ON USER_ROLES(USER_ID);
CREATE INDEX IDX_USER_ROLES_ROLE ON USER_ROLES(ROLE_ID);

-- ==============================
-- DATOS INICIALES
-- ==============================

-- Roles base
INSERT INTO ROLES (NAME) VALUES ('ADMIN');
INSERT INTO ROLES (NAME) VALUES ('USER');
INSERT INTO ROLES (NAME) VALUES ('GUEST');

-- Usuarios base (passwords de ejemplo)
INSERT INTO USERS (EMAIL, DISPLAY_NAME, PASSWORD_HASH)
VALUES ('admin@labs.cl', 'Administrador', '{noop}Admin1234!');
INSERT INTO USERS (EMAIL, DISPLAY_NAME, PASSWORD_HASH)
VALUES ('user@labs.cl', 'Usuario Regular', '{noop}User1234!');
INSERT INTO USERS (EMAIL, DISPLAY_NAME, PASSWORD_HASH)
VALUES ('guest@labs.cl', 'Invitado', '{noop}Guest1234!');

-- Asignar roles
INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT U.ID, R.ID FROM USERS U, ROLES R WHERE U.EMAIL='admin@labs.cl' AND R.NAME='ADMIN';
INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT U.ID, R.ID FROM USERS U, ROLES R WHERE U.EMAIL='user@labs.cl' AND R.NAME='USER';
INSERT INTO USER_ROLES (USER_ID, ROLE_ID)
SELECT U.ID, R.ID FROM USERS U, ROLES R WHERE U.EMAIL='guest@labs.cl' AND R.NAME='GUEST';

COMMIT;

SELECT * FROM ROLES;

-- =====================================
-- TABLA: LABORATORIO
-- =====================================
CREATE TABLE LABORATORIO (
  ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NOMBRE         VARCHAR2(200) NOT NULL,
  DIRECCION      VARCHAR2(300),
  TELEFONO       VARCHAR2(20),
  CORREO_CONTACTO VARCHAR2(100),
  ACTIVO         CHAR(1) DEFAULT 'Y' CHECK (ACTIVO IN ('Y','N')),
  FECHA_REGISTRO TIMESTAMP DEFAULT SYSTIMESTAMP
);

-- =====================================
-- TABLA: EXAMEN
-- =====================================
CREATE TABLE EXAMEN (
  ID             NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NOMBRE         VARCHAR2(200) NOT NULL,
  DESCRIPCION    VARCHAR2(500),
  COSTO          NUMBER(10,2) NOT NULL,
  LABORATORIO_ID NUMBER NOT NULL,
  CONSTRAINT FK_EXAMEN_LAB FOREIGN KEY (LABORATORIO_ID)
      REFERENCES LABORATORIO(ID) ON DELETE CASCADE
);

-- =====================================
-- TABLA: ORDEN_EXAMEN
-- =====================================
CREATE TABLE ORDEN_EXAMEN (
  ID              NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  PACIENTE_NOMBRE VARCHAR2(200) NOT NULL,
  PACIENTE_RUN    VARCHAR2(20),
  MEDICO          VARCHAR2(200),
  FECHA_ORDEN     TIMESTAMP DEFAULT SYSTIMESTAMP,
  TOTAL           NUMBER(12,2)
);

-- =====================================
-- TABLA: DETALLE_ORDEN
-- =====================================
CREATE TABLE DETALLE_ORDEN (
  ID              NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ORDEN_ID        NUMBER NOT NULL,
  EXAMEN_ID       NUMBER NOT NULL,
  RESULTADO       VARCHAR2(4000),
  FECHA_RESULTADO TIMESTAMP,
  CONSTRAINT FK_DETALLE_ORDEN FOREIGN KEY (ORDEN_ID)
      REFERENCES ORDEN_EXAMEN(ID) ON DELETE CASCADE,
  CONSTRAINT FK_DETALLE_EXAMEN FOREIGN KEY (EXAMEN_ID)
      REFERENCES EXAMEN(ID)
);

CREATE INDEX IDX_LAB_NOMBRE ON LABORATORIO(NOMBRE);
CREATE INDEX IDX_EXAMEN_NOMBRE ON EXAMEN(NOMBRE);
CREATE INDEX IDX_ORDEN_FECHA ON ORDEN_EXAMEN(FECHA_ORDEN);

-- Laboratorios de ejemplo
INSERT INTO LABORATORIO (NOMBRE, DIRECCION, TELEFONO, CORREO_CONTACTO)
VALUES ('Laboratorio Central', 'Av. Salud 123, Santiago', '+56 2 555 1000', 'contacto@labcentral.cl');

INSERT INTO LABORATORIO (NOMBRE, DIRECCION, TELEFONO, CORREO_CONTACTO)
VALUES ('BioLab Clínica Norte', 'Av. Providencia 850', '+56 2 555 2000', 'info@biolabnorte.cl');

-- Exámenes de ejemplo
INSERT INTO EXAMEN (NOMBRE, DESCRIPCION, COSTO, LABORATORIO_ID)
VALUES ('Hemograma Completo', 'Análisis de glóbulos rojos, blancos y plaquetas', 8900, 1);

INSERT INTO EXAMEN (NOMBRE, DESCRIPCION, COSTO, LABORATORIO_ID)
VALUES ('Perfil Lipídico', 'Colesterol total, HDL, LDL y triglicéridos', 12500, 1);

INSERT INTO EXAMEN (NOMBRE, DESCRIPCION, COSTO, LABORATORIO_ID)
VALUES ('PCR Covid-19', 'Detección del virus SARS-CoV-2 mediante PCR', 25000, 2);

-- Orden de ejemplo
INSERT INTO ORDEN_EXAMEN (PACIENTE_NOMBRE, PACIENTE_RUN, MEDICO, TOTAL)
VALUES ('Juan Pérez', '12.345.678-9', 'Dra. Carolina Soto', 21400);

-- Detalle de la orden
INSERT INTO DETALLE_ORDEN (ORDEN_ID, EXAMEN_ID, RESULTADO, FECHA_RESULTADO)
VALUES (1, 1, 'Valores dentro de rango normal', SYSTIMESTAMP);

INSERT INTO DETALLE_ORDEN (ORDEN_ID, EXAMEN_ID, RESULTADO, FECHA_RESULTADO)
VALUES (1, 2, 'Triglicéridos levemente elevados', SYSTIMESTAMP);

COMMIT;

SELECT COUNT(*) FROM LABORATORIO;
SELECT COUNT(*) FROM EXAMEN;
SELECT COUNT(*) FROM ORDEN_EXAMEN;
SELECT COUNT(*) FROM DETALLE_ORDEN;

---- POBLAR TABLA DE MICRO SERVICIO USERS CON USUARIO  LAB_USERS
CREATE TABLE ROLES (
    ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(50) NOT NULL UNIQUE
);

CREATE TABLE USERS (
    ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(100) NOT NULL UNIQUE,
    EMAIL VARCHAR2(150) NOT NULL UNIQUE,
    PASSWORD VARCHAR2(200) NOT NULL,
    ROLE_ID NUMBER,
    CREATED_AT DATE DEFAULT SYSDATE,
    CONSTRAINT FK_USER_ROLE FOREIGN KEY (ROLE_ID) REFERENCES ROLES(ID)
);

-- 6. Insertar datos iniciales (roles y un usuario de prueba)
INSERT INTO ROLES (NAME) VALUES ('ADMIN');
INSERT INTO ROLES (NAME) VALUES ('USER');

INSERT INTO USERS (USERNAME, EMAIL, PASSWORD, ROLE_ID)
VALUES ('admin', 'admin@labusers.cl', 'admin123', 1);